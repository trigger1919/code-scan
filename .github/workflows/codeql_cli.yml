name: CodeQL cli
on:
  workflow_dispatch:

jobs:
  codeql-cli:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: get codeql
        shell: bash
        run: |
         set -euxo pipefail
          curl -L -o codeql-bundle.tar.gz \
            https://github.com/github/codeql-action/releases/latest/download/codeql-bundle-linux64.tar.gz
          tar -xzf codeql-bundle.tar.gz
          # Add the extracted 'codeql' dir to PATH for the rest of the job
          echo "$PWD/codeql" >> "$GITHUB_PATH"


      - name: Verify CodeQL is on PATH
        shell: bash
        run: |
          set -euxo pipefail
          echo "PATH is: $PATH"
          which codeql
          codeql version


      - name: Pre-download Python queries pack (idempotent)
        shell: bash
        run: |
          set -euxo pipefail
          codeql pack download codeql/python-queries
          # Helpful for debugging pack resolution if needed:
          codeql resolve qlpacks | sed -n '1,120p

      
      - name: create db
        run: |
          codeql database create db-python \
            --language=python \
            --source-root .

      - name: analyze
        run: |
          codeql database analyze db-python codeql/python-queries:codeql-suites/python-security-and-quality --format=sarifv2.1.0 --output=results.sarif --download \
            --no-default-config \
            --threads=0 \
            --sarif-category=python
  
      - name: upload
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        
